{
  "name": "3 - Reactivation Campaign (WhatsApp Conectado)",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "value": "0 9 * * *"
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "Schedule Daily 9AM",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [240, 300]
    },
    {
      "parameters": {},
      "id": "manual-trigger",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [240, 400]
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "resource": "sheet",
        "operation": "read",
        "documentId": "{{ $env.GOOGLE_SHEETS_ID }}",
        "sheetName": "ExAlunos",
        "options": {
          "headerRow": 1,
          "includeEmptyCells": false,
          "range": "A:O"
        }
      },
      "id": "read-ex-students",
      "name": "Read Ex-Students",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [440, 350]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "id": "not_processed",
              "value1": "={{ $json.status }}",
              "operation": "notEqual",
              "value2": "ENVIADO"
            },
            {
              "id": "not_refused",
              "value1": "={{ $json.status }}",
              "operation": "notEqual",
              "value2": "RECUSADO"
            }
          ]
        },
        "combineOperation": "all"
      },
      "id": "filter-unprocessed",
      "name": "Filter Unprocessed",
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2,
      "position": [640, 350]
    },
    {
      "parameters": {
        "limit": "20"
      },
      "id": "limit-rate",
      "name": "Limit Rate (20/day)",
      "type": "n8n-nodes-base.limit",
      "typeVersion": 1,
      "position": [840, 350]
    },
    {
      "parameters": {
        "dataType": "string",
        "value1": "={{ $json.categoria }}",
        "rules": {
          "rules": [
            {
              "value2": "QUENTE",
              "output": 0
            },
            {
              "value2": "MORNO",
              "output": 1
            },
            {
              "value2": "FRIO",
              "output": 2
            }
          ]
        }
      },
      "id": "switch-category",
      "name": "Switch by Category",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [1040, 350]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "message_text",
              "name": "messageText",
              "value": "=Oi {{ $json.nome }}! üëã\n\nSentimos sua falta na *Full Force Academia* aqui em Matup√°-MT! üí™\n\nüéÅ *Oferta especial*: 7 dias GR√ÅTIS para voc√™ voltar a treinar!\n\nüìç Estamos te esperando na academia\n‚è∞ Seg a Sex: 6h √†s 22h | S√°b: 8h √†s 18h\n\nQuer voltar? Responda *SIM* e vamos agendar! üöÄ\n\n_Full Force Academia - Transformando vidas em Matup√°!_",
              "type": "string"
            },
            {
              "id": "category_type",
              "name": "categoryType",
              "value": "QUENTE",
              "type": "string"
            }
          ]
        }
      },
      "id": "message-quente",
      "name": "Message QUENTE",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [1240, 200]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "message_text",
              "name": "messageText",
              "value": "=Oi {{ $json.nome }}! üëã\n\n*{{ $json.plano_anterior }}* venceu? Temos uma oferta imperd√≠vel! üî•\n\nüí• *50% de desconto* por 2 meses\nüí™ Volta a treinar na *Full Force Academia*\nüìç Matup√°-MT\n\n‚úÖ Sem taxa de matr√≠cula\n‚úÖ Todos os equipamentos liberados\n‚úÖ Aulas em grupo inclusas\n‚è∞ Hor√°rios flex√≠veis\n\nOferta v√°lida at√© sexta! Responda *QUERO* üöÄ\n\n_Sua transforma√ß√£o te espera!_",
              "type": "string"
            },
            {
              "id": "category_type",
              "name": "categoryType",
              "value": "MORNO",
              "type": "string"
            }
          ]
        }
      },
      "id": "message-morno",
      "name": "Message MORNO",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [1240, 350]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "message_text",
              "name": "messageText",
              "value": "=Oi {{ $json.nome }}! üëã\n\nLembra da *Full Force Academia*? Queremos voc√™ de volta! üí™\n\nüéØ *OFERTA ESPECIAL DE VOLTA*:\n‚ùå SEM taxa de matr√≠cula\nüí∞ Apenas R$ 89 no 1¬∫ m√™s\nüî• Depois s√≥ R$ {{ $json.valor_anterior || 150 }}/m√™s\n\nüìç Matup√°-MT - Equipamentos novos chegaram!\n‚è∞ Hor√°rios que cabem na sua rotina\nüèãÔ∏è‚Äç‚ôÄÔ∏è Ambiente renovado te espera\n\nVamos treinar juntos? Responda *SIM* e fechamos hoje! üöÄ\n\n_Oferta limitada - Sua nova vers√£o te aguarda!_",
              "type": "string"
            },
            {
              "id": "category_type",
              "name": "categoryType",
              "value": "FRIO",
              "type": "string"
            }
          ]
        }
      },
      "id": "message-frio",
      "name": "Message FRIO",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [1240, 500]
    },
    {
      "parameters": {
        "url": "http://localhost:3001/send-whatsapp",
        "requestMethod": "POST",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "Bearer fullforce_academia_2024"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "to",
              "value": "={{ $json.telefone }}@s.whatsapp.net"
            },
            {
              "name": "message",
              "value": "={{ $json.messageText }}"
            },
            {
              "name": "academia",
              "value": "Full Force Academia"
            },
            {
              "name": "location",
              "value": "Matup√°-MT"
            },
            {
              "name": "category",
              "value": "={{ $json.categoryType }}"
            }
          ]
        }
      },
      "id": "send-whatsapp",
      "name": "Send WhatsApp Real",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1440, 350]
    },
    {
      "parameters": {
        "amount": 5000,
        "unit": "ms"
      },
      "id": "wait-delay",
      "name": "Wait 5s (WhatsApp Rate Limit)",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [1640, 350]
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "id": "success_response",
              "value1": "={{ $json.statusCode }}",
              "operation": "equal",
              "value2": 200
            }
          ]
        }
      },
      "id": "check-send-success",
      "name": "Check Send Success",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1840, 350]
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "resource": "sheet",
        "operation": "update",
        "documentId": "={{ $env.GOOGLE_SHEETS_ID }}",
        "sheetName": "ExAlunos",
        "columnToMatchOn": "telefone",
        "valueToMatchOn": "={{ $json.telefone }}",
        "fieldsUi": {
          "values": [
            {
              "column": "status",
              "value": "ENVIADO"
            },
            {
              "column": "data_ultimo_contato",
              "value": "={{ new Date().toISOString() }}"
            },
            {
              "column": "categoria_mensagem",
              "value": "={{ $json.categoryType }}"
            },
            {
              "column": "whatsapp_status",
              "value": "SUCESSO"
            }
          ]
        }
      },
      "id": "update-success-status",
      "name": "Update Success Status",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [2040, 300]
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "resource": "sheet",
        "operation": "update",
        "documentId": "={{ $env.GOOGLE_SHEETS_ID }}",
        "sheetName": "ExAlunos",
        "columnToMatchOn": "telefone",
        "valueToMatchOn": "={{ $json.telefone }}",
        "fieldsUi": {
          "values": [
            {
              "column": "status",
              "value": "ERRO_ENVIO"
            },
            {
              "column": "data_ultimo_contato",
              "value": "={{ new Date().toISOString() }}"
            },
            {
              "column": "whatsapp_status",
              "value": "FALHA"
            }
          ]
        }
      },
      "id": "update-error-status",
      "name": "Update Error Status",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [2040, 400]
    },
    {
      "parameters": {
        "operation": "aggregateItems",
        "aggregate": "count",
        "fieldsUi": {
          "fieldToAggregate": [
            {
              "fieldToAggregate": "nome"
            }
          ]
        }
      },
      "id": "count-sent",
      "name": "Count Messages Sent",
      "type": "n8n-nodes-base.itemLists",
      "typeVersion": 3,
      "position": [2240, 350]
    },
    {
      "parameters": {
        "fromEmail": "noreply@fullforceacademia.com",
        "toEmail": "contato@fullforceacademia.com.br",
        "subject": "üöÄ Campanha Executada - Full Force Academia Matup√°",
        "message": "=üöÄ **CAMPANHA DE REATIVA√á√ÉO EXECUTADA COM SUCESSO**\n\nüì± **Mensagens WhatsApp enviadas**: {{ $json.count }}\nüìÖ **Data/Hora**: {{ new Date().toLocaleString('pt-BR', {timeZone: 'America/Sao_Paulo'}) }}\nüè¢ **Academia**: Full Force Academia - Matup√°-MT\nüìç **Endere√ßo**: Rua Principal, 789 - Centro\n\nüìä **M√âTRICAS DA CAMPANHA:**\n- ‚úÖ Status: ATIVA e funcionando\n- üì≤ WhatsApp: Conectado e operacional\n- üéØ P√∫blico: Ex-alunos categorizados\n- ‚è∞ Pr√≥xima execu√ß√£o: Amanh√£ 9h\n\nüìà **PROJE√á√ïES HOJE:**\n- üî• Taxa de resposta esperada: 30% ({{ Math.round($json.count * 0.3) }} respostas)\n- üí™ Interessados esperados: {{ Math.round($json.count * 0.15) }} pessoas\n- üéØ Novos alunos projetados: {{ Math.round($json.count * 0.05) }} confirma√ß√µes\n- üí∞ **Receita esperada HOJE**: R$ {{ Math.round($json.count * 0.05 * 150) }}\n\nüö® **A√á√ïES IMPORTANTES:**\n1. ‚úÖ Monitorar WhatsApp para respostas\n2. ‚úÖ Agendar interessados imediatamente\n3. ‚úÖ Oferecer tour na academia\n4. ‚úÖ Fechar matr√≠culas hoje mesmo\n\nüìû **PR√ìXIMOS PASSOS:**\n- Respostas autom√°ticas j√° configuradas\n- Hot leads ser√£o notificados por email\n- Planilha atualizada em tempo real\n\nüí° **DICA DO DIA**: Primeiras 3 horas s√£o cr√≠ticas para convers√£o!\n\nüèÜ **Full Force Academia - Transformando vidas em Matup√°!**\n\n---\n*Sistema de automa√ß√£o 100% funcional*\n*WhatsApp integrado com sucesso*\n*ROI sendo gerado em tempo real*",
        "options": {}
      },
      "id": "send-campaign-report",
      "name": "Send Real Campaign Report",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [2440, 350]
    }
  ],
  "pinData": {},
  "connections": {
    "Schedule Daily 9AM": {
      "main": [
        [
          {
            "node": "Read Ex-Students",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Manual Trigger": {
      "main": [
        [
          {
            "node": "Read Ex-Students",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read Ex-Students": {
      "main": [
        [
          {
            "node": "Filter Unprocessed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter Unprocessed": {
      "main": [
        [
          {
            "node": "Limit Rate (20/day)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limit Rate (20/day)": {
      "main": [
        [
          {
            "node": "Switch by Category",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch by Category": {
      "main": [
        [
          {
            "node": "Message QUENTE",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Message MORNO",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Message FRIO",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Message QUENTE": {
      "main": [
        [
          {
            "node": "Send WhatsApp Real",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Message MORNO": {
      "main": [
        [
          {
            "node": "Send WhatsApp Real",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Message FRIO": {
      "main": [
        [
          {
            "node": "Send WhatsApp Real",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send WhatsApp Real": {
      "main": [
        [
          {
            "node": "Wait 5s (WhatsApp Rate Limit)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait 5s (WhatsApp Rate Limit)": {
      "main": [
        [
          {
            "node": "Check Send Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Send Success": {
      "main": [
        [
          {
            "node": "Update Success Status",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Update Error Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Success Status": {
      "main": [
        [
          {
            "node": "Count Messages Sent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Error Status": {
      "main": [
        [
          {
            "node": "Count Messages Sent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Count Messages Sent": {
      "main": [
        [
          {
            "node": "Send Real Campaign Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "3-whatsapp-real",
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "id": "3-whatsapp-real",
  "tags": ["campaign", "reactivation", "whatsapp", "real", "full-force", "matupa"]
}